name: po-merge-bot

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [master, main]
  schedule:
    - cron: '*/5 * * * *'

jobs:
  conflict-check:
    if: github.event_name == 'pull_request' || github.event_name == 'push' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Check PRs for .po conflicts
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            console.log(`Found ${prs.data.length} open PRs`);

            for (const pr of prs.data) {
              console.log(`Checking PR #${pr.number}: ${pr.title}`);

              const prData = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              console.log(`  mergeable: ${prData.data.mergeable}, mergeable_state: ${prData.data.mergeable_state}`);

              if (prData.data.mergeable_state !== 'dirty') {
                console.log(`  Skipping - no conflicts`);
                continue;
              }

              const files = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              const hasPoFiles = files.data.some(f => f.filename.endsWith('.po'));
              if (!hasPoFiles) {
                continue;
              }

              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number
              });

              const alreadyCommented = comments.data.some(c =>
                c.user.login === 'github-actions[bot]' &&
                c.body.includes('/po-rebase')
              );

              if (alreadyCommented) {
                continue;
              }

              const body = [
                'This PR has conflicts in `.po` translation files.',
                '',
                `Comment \`/po-rebase\` to rebase onto \`${prData.data.base.ref}\` and auto-resolve .po conflicts.`
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: body
              });

              console.log(`Commented on PR #${pr.number}`);
            }

  po-rebase:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/po-rebase')

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('head_ref', pr.data.head.ref);
            core.setOutput('base_ref', pr.data.base.ref);

            const permission = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });
            const canWrite = ['admin', 'write'].includes(permission.data.permission);
            core.setOutput('can_write', canWrite);

      - name: Check permissions
        if: steps.pr.outputs.can_write != 'true'
        run: |
          echo "User does not have write permission"
          exit 1

      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install gettext
        run: sudo apt-get update && sudo apt-get install -y gettext

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install po-merge
        run: pip install .

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git config merge.po-merge.name "PO file merge driver"
          git config merge.po-merge.driver "po-merge-driver %O %A %B"

          mkdir -p .git/info
          echo "*.po merge=po-merge" >> .git/info/attributes

      - name: Parse options from comment
        id: options
        run: |
          COMMENT="${{ github.event.comment.body }}"

          if [[ "$COMMENT" =~ strategy=(none|ours|theirs) ]]; then
            echo "Found strategy=${BASH_REMATCH[1]}"
            git config merge.po-merge.strategy "${BASH_REMATCH[1]}"
          fi

          if [[ "$COMMENT" =~ prefer-non-fuzzy=(true|false) ]]; then
            echo "Found prefer-non-fuzzy=${BASH_REMATCH[1]}"
            git config merge.po-merge.prefer-non-fuzzy "${BASH_REMATCH[1]}"
          fi

          if [[ "$COMMENT" =~ validate-compiled=(true|false) ]]; then
            echo "Found validate-compiled=${BASH_REMATCH[1]}"
            git config merge.po-merge.validate-compiled "${BASH_REMATCH[1]}"
          fi

      - name: Rebase PR onto target
        id: rebase
        run: |
          set -o pipefail
          git checkout "${{ steps.pr.outputs.head_ref }}"
          git rebase "origin/${{ steps.pr.outputs.base_ref }}" 2>&1 | tee /tmp/rebase.log || {
            echo "rebase_log<<EOF" >> $GITHUB_OUTPUT
            cat /tmp/rebase.log >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          }

      - name: Push rebased branch
        run: |
          git push --force-with-lease origin "${{ steps.pr.outputs.head_ref }}"

      - name: Comment success
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'Rebased onto `${{ steps.pr.outputs.base_ref }}` with po-merge. You can now merge normally.'
            });

      - name: Comment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const log = `${{ steps.rebase.outputs.rebase_log }}`;

            const poMergeConflicts = log.match(/CONFLICT: msgid "(.+?)"/g);
            const hasParseErrors = log.includes('po-merge: parse errors');
            const hasValidationError = log.includes('po-merge: merged file failed msgfmt');
            const hasNonPoConflict = log.includes('CONFLICT') && !poMergeConflicts;

            let body = '';

            if (poMergeConflicts && poMergeConflicts.length > 0) {
              const conflicts = poMergeConflicts.map(c => c.replace('CONFLICT: msgid ', '- ')).join('\n');
              body = [
                '`.po` conflicts could not be auto-resolved:',
                '',
                conflicts,
                '',
                'Options:',
                '- `/po-rebase strategy=ours` - keep your translations',
                '- `/po-rebase strategy=theirs` - use target branch translations',
                '- Fix manually and push',
              ].join('\n');
            } else if (hasParseErrors) {
              body = 'Rebase failed: po-merge could not parse one or more input files.';
            } else if (hasValidationError) {
              body = 'Rebase failed: merged .po file failed msgfmt validation.';
            } else if (hasNonPoConflict) {
              body = [
                'Rebase failed due to conflicts in non-`.po` files.',
                '',
                'Please resolve these conflicts manually first, then try again.',
              ].join('\n');
            } else {
              body = 'Rebase failed unexpectedly.';
            }

            body += `\n\n[Workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
